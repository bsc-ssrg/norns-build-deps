language: bash
services: docker

env:
  global:
    - ORGANIZATION=bscstorage
    - secure: EwOpW/FYulws+vVM+pKu6KtgXi6sDEYgROAn+6T29UqDN/raRNAPTkv7AxtxcxfEhFvbCy3PFi/TZIdy93k8ReXphEYs9bptFmZxIn9xMTJNxS781PuI6o2V+EkhzvzWBLseujFF14mtoBZ7nCJCkAohDcc0fesL0A8tQOmvtDC+39CNIyNdhVXVc/iwW2V5xAlh7nK7nAii2AHrzcozxMNkOnLhXgr+ncNSD7HBx4luS1RjHvdl+xBTaILMYcymKQpitYqw0eOOi0JmGd4q6tkX2e4pMOBjxlA1FS/RXmYac9pZlh93Bi2JXushfXyAr9tf1E/t0tkH+c8l9fUtIszqfevMb8dzAuhVjiPZy4hFTPeA4EAv+X/2HEkxLr1tLH+FvN0zpSAJF6//3Lt8EDObgFC6wnkHla1W/latQl0NlusK40iVxssXu+iSJtqaJi8BNSmZujRXa8JQemukccvUXFfpMQDpbGwoFyXXLdGX4cyiDRsShJBfr0FA3AZF/wtSGR2MbQY/oMoBy7LI0AUleIJRbkIoFHOJaxa4Kqdd0HeLPqDyxUGDOZTGRMGcvqBJmnHwOnAEyXnGCaQJrL1mjejv62+Unna6K5tzi4V9JD665JnVOxdo3NVkTlOgW8i4dCaqsNoyljTf45EthjPgiSVtAvfCkvInkhPx7AU=
    - secure: p4IdmWGUWSc9m5sSrdWyW7cd2W6VjkM1764V/bCzWIfbo+qGuodJ+s0XQ89Qi/4oB3Jlg4FaSwc6SnpRpGXE6c9pfEnZMj7avaAKLysfRzEnjH8WSb4NYTW0QSKpPHV3EvOca8xb8sc6rJU3G8DrDN+m7h1CflF8bh23Smh/kLp0i/0JvG/x5kKdeUNKfYNeQHvDUMYNaolEiOClaSuBV2ND/UOovwu8B4O8eemtnhSBK+vom3clLCvivvrc4GIrust2xR8Vm58e5rcXjJ+n1SzaAy8HC41qXQ9Cc7eaxMzuzJpVzrzJgExC9N0Yf/Y5wQSaiUg3PNV+j6GZWSzpOKmlevBOUPwU7voS+J+KYV23XNkWgjyKcxOtlpfqNo/RNo73eG721q2bfj2y1+6JGkFc9DDDQul94J29kAzeZJMTyDrK5frxdxsnbL9RnqHJhbNNpMP7bg9G7Q7LoybKfFa5YMGuhQT2v887dvF1eAHxcH72m7K1oCJmMaSYln3c3PWRWSMNBR99QS1JLKKEH0cPgk1NBRXiPJNUNmtwZTeI1zApq7tpeWv7qKtj+wf9vltjT6TVGGPUzKwaweSyUWyZ9fg3TK4bnffkQBIRbiw5Ri/BSvEpC3K92UFd/oj+pfTHE1ztiKGgoOE0N1+wFE+Av/EndGkbGvL2x5sRdCQ=
  matrix:
    - COMPILER=gcc    COMPILER_VERSION=4.8  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=gcc    COMPILER_VERSION=4.9  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=gcc    COMPILER_VERSION=5.4  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=gcc    COMPILER_VERSION=6.5  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=gcc    COMPILER_VERSION=7.4  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=gcc    COMPILER_VERSION=8.1  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=gcc    COMPILER_VERSION=9.1  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=clang  COMPILER_VERSION=4.8  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=clang  COMPILER_VERSION=4.9  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=clang  COMPILER_VERSION=5.4  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=clang  COMPILER_VERSION=6.5  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=clang  COMPILER_VERSION=7.4  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=clang  COMPILER_VERSION=8.1  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1
      #    - COMPILER=clang  COMPILER_VERSION=9.1  LIBFABRIC_VERSION=1.7.1  MERCURY_VERSION=1.0.1

before_script:
  - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"
  - env | sort
  - cd "${COMPILER}/${COMPILER_VERSION}"
  - IMAGE="norns-build-deps:${COMPILER}${COMPILER_VERSION}-libfabric${LIBFABRIC_VERSION}-mercury${MERCURY_VERSION}"

script:
  - |
    (
      set -Eeuo pipefail
      set -x
      docker build --pull --cache-from "${ORGANIZATION}/${IMAGE}" --build-arg LIBFABRIC_VERSION="v${LIBFABRIC_VERSION}" --build-arg MERCURY_VERSION="v${MERCURY_VERSION}" --tag "${IMAGE}" .
      docker run -ti --rm "$IMAGE" "$COMPILER" --version
    )

after_script:
  - docker images

before_deploy:
  - docker login -u "$REGISTRY_USER" -p "$REGISTRY_PASS"

deploy:
  provider: script
  script: 
    - docker push "$ORGANIZATION"/"$IMAGE"
  on:
    branch: master
